<!DOCTYPE html>
<html>
<head>
    <title>Under the Bell Tower</title>
    <style>
        :root { --purdue-gold: #CEB888; --iu-crimson: #990000; }
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; display: flex; margin: 0; height: 100vh; }
        #sidebar { width: 220px; background: #000; border-right: 2px solid var(--purdue-gold); padding: 20px; }
        #main { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .track { display: flex; gap: 10px; background: #222; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .slot { width: 80px; height: 110px; border: 2px dashed #555; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: bold; }
        .filled-tradition { background: var(--purdue-gold); color: black; border: none; }
        .filled-construction { background: var(--iu-crimson); color: white; border: none; }
        button { padding: 10px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        .gold-btn { background: var(--purdue-gold); color: black; }
        .policy-card { background: white; color: black; padding: 20px; margin: 10px; display: inline-block; cursor: pointer; border-radius: 5px; width: 80px; font-weight: bold; }
        #voteUI { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        #status { background: var(--purdue-gold); color: black; padding: 10px; margin-bottom: 10px; font-weight: bold; display: none; border-radius: 5px; width: 80%; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color:var(--purdue-gold)">Students</h2>
    <div id="playerList"></div>
</div>

<div id="main">
    <div id="status"></div>

    <div id="setup">
        <h1>ðŸ”” Under the Bell Tower</h1>
        <input id="username" placeholder="Name">
        <button class="gold-btn" onclick="join()">Enter Lobby</button>
    </div>

    <div id="gameUI" style="display:none">
        <div class="track" id="traditionTrack"></div>
        <div class="track" id="constructionTrack"></div>

        <p id="roleSecret" style="color:var(--purdue-gold); font-size: 1.2rem;">Role Hidden</p>
        <button class="gold-btn" onmousedown="reveal()" onmouseup="hide()" ontouchstart="reveal()" ontouchend="hide()">HOLD TO REVEAL</button>

        <div id="electionBox" style="margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
            <input id="nominee" placeholder="Nominate VP">
            <button class="gold-btn" onclick="nominate()">Nominate</button>
            <br>
            <button id="drawBtn" onclick="drawCards()" style="background:white; color:black; display:none; margin-top:15px; border: 3px solid var(--purdue-gold);">PRESIDENT: DRAW 3 POLICIES</button>
        </div>

        <div id="legisArea" style="display:none; background:#333; padding: 20px; margin-top: 20px; border-radius: 10px;">
            <h4 id="legisTitle">Legislative Session</h4>
            <div id="policyButtons"></div>
        </div>
    </div>

    <div id="lobbyControls" style="display:none; margin-top: 20px;">
        <button class="gold-btn" onclick="startGame()">START GAME</button>
    </div>
</div>

<div id="voteUI">
    <h2 id="voteTitle"></h2>
    <button class="gold-btn" onclick="castVote('Boiler Up!')" style="font-size: 1.5rem;">ðŸš‚ Boiler Up!</button>
    <button style="background:var(--iu-crimson); color:white; font-size: 1.5rem;" onclick="castVote('Hammer Down!')">ðŸ”¨ Hammer Down!</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myName = "", myRole = "", myId = "";

    socket.on('connect', () => { myId = socket.id; });

    function showStatus(msg) {
        const s = document.getElementById('status');
        s.innerText = msg; s.style.display = 'block';
        setTimeout(() => { s.style.display = 'none'; }, 5000);
    }

    function join() {
        myName = document.getElementById('username').value;
        if(myName) {
            socket.emit('joinGame', myName);
            document.getElementById('setup').style.display = 'none';
            document.getElementById('lobbyControls').style.display = 'block';
        }
    }

    function startGame() { socket.emit('startGame'); }

    socket.on('updatePlayerList', (p) => {
        document.getElementById('playerList').innerHTML = p.map(x => `<div>ðŸš‚ ${x.name}</div>`).join('');
    });

    socket.on('assignRole', (role) => {
        myRole = role;
        document.getElementById('lobbyControls').style.display = 'none';
        document.getElementById('gameUI').style.display = 'block';
        updateBoard({tradition:[], construction:[]});
    });

    function reveal() { document.getElementById('roleSecret').innerText = myRole; }
    function hide() { document.getElementById('roleSecret').innerText = "Role Hidden"; }

    function nominate() {
        const val = document.getElementById('nominee').value;
        if(val) socket.emit('nominateVP', val);
    }

    socket.on('showVote', (data) => {
        document.getElementById('voteTitle').innerText = `Elect ${data.president} & ${data.vp}?`;
        document.getElementById('voteUI').style.display = 'flex';
    });

    function castVote(c) {
        socket.emit('submitVote', { name: myName, choice: c });
        document.getElementById('voteUI').style.display = 'none';
    }

    socket.on('electionPassed', (data) => {
        showStatus(data.msg);
        if(myId === data.presId) {
            document.getElementById('drawBtn').style.display = 'inline-block';
        }
    });

    socket.on('electionFailed', (msg) => { showStatus(msg); });

    function drawCards() { 
        socket.emit('drawPolicies'); 
        document.getElementById('drawBtn').style.display = 'none';
    }

    socket.on('presidentHand', (hand) => {
        document.getElementById('legisArea').style.display = 'block';
        document.getElementById('legisTitle').innerText = "President: Discard 1 Card";
        const area = document.getElementById('policyButtons');
        area.innerHTML = '';
        hand.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = 'policy-card';
            card.innerText = p;
            card.onclick = () => {
                let rem = [...hand]; rem.splice(i, 1);
                socket.emit('presidentDiscard', rem);
                document.getElementById('legisArea').style.display = 'none';
            };
            area.appendChild(card);
        });
    });

    socket.on('vpHand', (hand) => {
        document.getElementById('legisArea').style.display = 'block';
        document.getElementById('legisTitle').innerText = "VP: Enact 1 Policy";
        document.getElementById('policyButtons').innerHTML = hand.map(p => 
            `<div class="policy-card" onclick="enact('${p}')">${p}</div>`).join('');
    });

    function enact(p) {
        socket.emit('enactPolicy', p);
        document.getElementById('legisArea').style.display = 'none';
    }

    function updateBoard(data) {
        const tTrack = document.getElementById('traditionTrack');
        const cTrack = document.getElementById('constructionTrack');
        tTrack.innerHTML = ''; cTrack.innerHTML = '';
        for(let i=0; i<5; i++){
            const p = data.tradition[i];
            tTrack.innerHTML += `<div class="slot ${p?'filled-tradition':''}">
                ${p ? `TRADITION<br><small>${p.pres}/${p.vp}</small>` : 'Empty'}</div>`;
        }
        for(let i=0; i<6; i++){
            const p = data.construction[i];
            cTrack.innerHTML += `<div class="slot ${p?'filled-construction':''}">
                ${p ? `CONSTRUCT<br><small>${p.pres}/${p.vp}</small>` : 'Empty'}</div>`;
        }
    }

    socket.on('policyUpdated', (data) => updateBoard(data));
    socket.on('statusMsg', (m) => showStatus(m));
</script>
</body>
</html>